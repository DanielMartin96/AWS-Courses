# AWS Fundamentals: ELB + ASG

## Elastic Load Balancing (ELB) Overview

### What is load balancing?
- Load Balancers are servers that forward traffic to multiple servers (eg. EC2 instances) downstream

### Why use a load balancer? 
- Spread load across multiple downstream instances
- Expose a single point of access (DNS) to your application
- Seamlessly handle failures of downstream instances
- Do regular health checks to your instances
- Provide SSL termination (HTTPS) for your websites
- Enforce stickiness with cookies
- High availability across zones
- Separate public traffic from private traffic

- An Elastic Load Balancer is a managed load balancer
- AWS guarantess that it will be working
- AWS takes care of upgrades, maintenance, high availability
- AWS provides only a few configuration knobs

- It costs less to setup your own load balancer but it will be a lot more effort on your end

- It is integrated with many AWS offerings/services
- EC2, EC2 Auto Scaling Groups, Amazon ECS
- AWS Certificate Manager (ACM), CloudWatch
- Route 53, AWS WAF, AWS Global Accelerator

### Health Checks 
- Health Checks are crucial for Load Balancers
- They enable the load balancer to know if instances it forwards traffic to are available to reply to requests
- The health check is done on a port and a route (/health is common)
- If the response is not 200 (OK), then the instance is unhealthy

### Types of Load Balancer of AWS
- AWS has 4 kinds of managed Load Balancers
- **Classic Load Balancer** (v1 - old generation) - 2009 - CLB: HTTP, HTTPS, TCP, SSL (secure TCP)\
- **Application Load Balancer** (v2 - new generation) - 2016 - ALB: HTTP, HTTPS, WebSocket
- **Netork Load Balancer** (v2 - new generation) - 2017 - NLB: TCP, TLS (secure TCP), UDP
- **Gateway Load Balancer** - 2020 - GWLB: Operates at layer 3 (Network layer) - IP Protocol

- Overall, it is recommended to use the new generation load balancers as they provide more features
- Some load balancers can be setup as internal (private) or external (public) ELBs\

## Application Load Balancer (ALB)

- Application load balancers is Layer 7 (HTTP)

- Load balancing to multiple HTTP applications across machines (target groups)
- Load balancing to multiple applications on the same machine (ex: container)
- Support for HTTP/2 and WebSocket
- Support redirects (from HTTP to HTTPS for example)
- Routing tables to different target groups: Routing based on path in URL. Routing based on hostname in URL. Routing based on Query Strings, Headers

- ALB are a great fit for microservices & container-based application (exampe: Docker & Amazon ECS)
- Has a port mapping feature to redirect to a dynamic port in ECS
- In comparison, we'd need multiple Class Load Balancer per application

### Target Groups
- EC2 instances (can be managed by an Auto Scaling Group) - HTTP
- ECS tasks (managed by ECS itself) - HTTP
- Lambda functions - HTTP request is translated into a JSON event
- IP Addresses - must be private IPs

- ALB can route to multiple target groups
- Health checks are at the target group level 

### Good to Know 
- Fixed hostname (XXX.region.elb.amazonaws.com)
- The application servers don't see the IP of the client directly
- The true IP of the client is inserted in the header **X-Forwarded-For**
- We can also get Port (X-Forwarded-Port) and proto (X-Forwarded-Proto)

## Network Load Balancer (NLB)

- Network load balancers is (Layer 4)
- **Forward TCP & UDP traffic to your instances**
- Handle millions of requests per second
- Less latency ~ 100ms (vs 400ms)

- **NLB has one static IP per AZ and supports assigning Elastic IP** (helpful for whitelisting specific IP)

- NLB are used for extreme peformance, TCP or UDP traffic
- Not included in the AWS free tier

## Gateway Load Balancer (GWLB)

- Deploy, scale and manage a fleed of 3rd part network virtual appliances in AWS
- Example: Fiewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation...

- Operates at Layer 3 (Network Layer) - IP Packets
- Combines the following functions: **Transport Network Gateway** - single entry/exit for all traffic. **Load Balancer** - distributes traffic to your virtual appliances
- Uses the **GENEVE** protocol on port 6081 

## Elastic Load Balancer - Sticky Sessions

### Sticky Sessions (Session Affinity)
- It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer
- This works for **Classic Load Balancer, Application Load Balancer and Network Load Balancer**
- The "cookie" used for stickiness has an expiration date you control
- Use case: make sure the user doesn't lose his session data
- Enabling stickiness may bring imbalance to the load over the backend EC2 instances

### Cookie Name
**Application based Cookies**
- Custom cookie:
- Generated by the target
- Can include any custom attributes required by the application
- Cookie name must be specified individually for each target group
- Don't use **AWSALB, AWSSALBAPP** or **AWSSALBTG** (reserved for use by the ELB)

- Application cookie:
- Generated by the load balancer
- Cookie name is **AWSALBAPP**

**Duration-based Cookies** 
- Cookie generated by the load balancer
- Cookie name is **AWSALB** for ALB, **AWSELB** for CLB

## Cross Zone Load Balancing 

**Application Load Balancer** 
- Enabled by default (can be disabled at the Target Group level)
- No charges for inter AZ data

**Network Load Balancer & Gateway Load Balancer** 
- Disabled by default
- You pay charges ($) for inter AZ data if enabled 

**Classic Load Balancer**
- Disabled by default
- No charges for inter AZ data if enabled

## SSL Certificates

### SSL/TLS - Basics
- An SSL Certificate allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption)

- **SSL** refers to Secure Sockets Layer, used to encrypt connections
- **TLS** refers to Transport Layer Security, which is a newer version
- Nowadays, **TLS certificates are mainly used,** but people still refer as SSL

- Public SSL certificates are issued by Certificate Authorities (CA)
- Comodo, Symantec, GoDaddy, GlobalSign, Digicert, Letsencrypt, etc...

- SSL certificates have an expiration date (you set) and must be renewed

### Load Balancer - SSL Certificates
- The load balancer uses an X.509 certificate (SSL/TLS server certificate)
- You can manage certificates using ACM (AWS Certificate Manager)
- You can create upload your own certificates alternatively
HTTPS Listener:
- You must specify a default certificate 
- You can add an optional list of certs to support multiple domains
- **Clients can use SNI (Server Name Indication) to specify the hostname they reach** 
- Ability to specifiy a security policy to support older versions of SSL/TLS (legacy clients)

### SSL - Server Name Indication
- SNI solves the problem of loading **multiple SSL certificates onto one web server** (to serve multiple websites) 
- It's a "newer" protocol and requires the client to **indicate** the hostname of the target server to the initial SSL handshake
- The server will then find the correct certificate or return the default one
- Only works for ALB & NLB (newer generation) and CloudFront
- Does not work for CLB (older generation)

### Elastic Load Balancers - SSL Certificates
**Classic Load Balancer (v1)**
- Support only one SSL certificate
- Must use multiple CLB for multiple hostname with multiple SSL certificates

**Application Load Balancer (v2)**
- Supports multiple listeners with multiple SSL certificates
- Uses Server Name Indication (SNI) to make it work

## Elastic Load Balancer - Connection Draining 

**Feature naming:**
- Connection Draining - for CLB
- Deregistration Delay - for ALB & NLB

- Time to complete "in-flight requests" while the instance is de-registering or unhealthy
- Stops sending new requests to the EC2 instance which is de-registering
- Between 1 to 3600 seconds (default: 300 seconds)
- Can be disabled (set value to 0)
- Set to a low value if your requests are short

## Auto Scaling Groups (ASG)

- In real-life, to load on your websites and applications can change
- In the cloud, you can create and get rid of servers very quicky

The goal of an Auto Scaling Group (ASG) is to:
- Scale out (add EC2 instances) to match an increased load
- Scale in (remove EC2 instances) to macth a decreased load 
- Ensure we have a minimum and a maximum number of EC2 instances running
- Automatically register new instances to a load balancer 
- Re-create an EC2 instance in case a previous one is terminated (ex: if unhealthy)

- ASG are free (you only pay for the underlying EC2 instances)

### Auto Scaling attributes
**Launch Template** 
 - AMI + Instance Type 
 - EC2 User Data 
 - EBS Volumes
 - Security Groups 
 - SSH Key Pair
 - IAM Roles for your EC2 Instances 
 - Network + Subnets Information
 - Load Balancer Information

 Min Size / Max Size / Initial Capacity
 Scaling Policies

### Auto Scaling - CloudWatch Alarms and Scaling 
- It is possible to scale an ASG based on CloudWatch alarms 
- An alarm monitors a metric (such as **Average CPU** or a **custom metric**)
- Metrics such as average CPU are computed for the overall ASG instances 
Based on the alarm:
- We can create scale-out policies (increase the number of instances)
- We can create scale-in policies (decrease the number of instances)

## Auto Scaling Groups - Scaling Policies
**Target Tracking Scaling**
- Most simple and easy to set-up
- Example: I want the average ASG CPU to stay around 40%
**Simple/Step Scaling**
- When a CloudWatch alarm is triggered (example CPU > 70%), then add 2 units
- When a CloudWatch alarm is triggered (example CPU < 30%), then remove 1 unit 
**Scheduled Actions**
- Anticipate a scaling based on known usage patterns
- Example: increase the min capacity to 10 at 5pm on Fridays
**Predictive scaling**
- Continuously forecast load and schedule scaling ahead

### Good metrics to scale on 
- **CPUUtilisation:** Average CPU utilisation across your instances 
- **RequestCountPerTarget:** to make sure the number of requests per EC2 is stable
- **Average Network In/Out**
- **Any custom metric** (that you push using CloudWatch) 

### Scaling Cooldowns
- After a scaling activity happens you are in the **cooldown period (default 300 seconds)** 
- During the cooldown period, the ASG will not launch or terminate additional instances (to allow for metrics to stablise)
- Advice: Use a ready-to-use AMI to reduce configuration time in order to be serving request faster and reduce the cooldown period

## Auto Scaling Groups - Instance Refresh

- Goal: update launch template and then re-creaeting all EC2 instances
- For this we can use the native feature of Instance Refresh
- Setting of minimum healthy percentage
